#!/bin/bash

set -x

if [[ $HOSTNAME =~ md-1 ]]; then
   sleep=0
else
   sleep=15
fi

metadata_host="a-1.thiss.io"

function exit_script_fail {
    local msg=$1
    local filetoremove=$2
    echo $msg
    echo "Removing: $filetoremove"
    rm -f $filetoremove
    echo "exiting script!"
    exit 1
    }

function fetch_metadata {
    local metadata_file=$1

    wget -qO$tmpf https://$metadata_host/$metadata_file && jq -e '.[].title' $tmpf >/dev/null 2>&1

    if [ $? -eq 0 ]; then
       cmp -s $tmpf /etc/thiss/$metadata_file
       test $? -ne 0 && restart=true || restart=false

       if [ $restart == true ]; then
           mv $tmpf /etc/thiss/$metadata_file
           sleep $sleep
           /usr/sbin/service sunet-thiss-mdq restart || exit_script_fail "Restarting thiss-mdq probably did not work" $tmpf
           fi

        touch /etc/thiss/$metadata_file
        rm -f $tmpf

    else
       exit_script_fail "$metadata_file is empty" $tmpf
    fi
    }

#fetch metadata.json
fetch_metadata metadata.json

#fetch metadata_sp.json
fetch_metadata metadata_sp.json