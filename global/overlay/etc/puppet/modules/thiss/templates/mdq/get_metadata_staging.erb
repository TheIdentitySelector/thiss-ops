#!/bin/bash

set -x

if [[ $HOSTNAME =~ md-1 ]]; then
   sleep=0
else
   sleep=15
fi


function exit_script_fail {
    local msg=$1
    local filetoremove=$2
    echo $msg
    echo "Removing: $filetoremove"
    rm -f $filetoremove
    echo "exiting script!"
    exit 1
    }

function fetch_metadata {
    local metadata_url=$1
    local metadata_file_path=$2

    tmpf=`mktemp`

    if [[ $metadata_url == *"sp"* ]]; then
       wget -qO$tmpf $metadata_url && jq -e '.[].entityID' $tmpf >/dev/null 2>&1
    else
       wget -qO$tmpf $metadata_url && jq -e '.[].title' $tmpf >/dev/null 2>&1
    fi

    if [ $? -eq 0 ]; then
       cmp -s $tmpf $metadata_file_path
       test $? -ne 0 && restart=true || restart=false

       if [ $restart == true ]; then
           mv $tmpf $metadata_file_path
           sleep $sleep
           <%= @post %> || exit_script_fail "Restarting thiss-mdq probably did not work" $tmpf
           fi

        touch $metadata_file_path
        rm -f $tmpf

    else
       exit_script_fail "$metadata_file_path is empty" $tmpf
    fi
    }

#fetch metadata.json
fetch_metadata <%= @src %> <%= @dst %>

#fetch metadata_sp.json
fetch_metadata <%= @src_trust %> <%= @dst_trust %>